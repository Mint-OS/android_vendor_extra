From 429a491bac8c8e3966f9afa5cc80becdb4677f9e Mon Sep 17 00:00:00 2001
From: 0xD34D <clark@scheffsblend.com>
Date: Mon, 9 Jan 2017 07:19:41 +0530
Subject: [PATCH 24/38] N-Extras: Add dynamic theme BootAnimation support

Extracted from "Themes: Port to CM13 [1/3]"
http://review.cyanogenmod.org/#/c/113273/14

Change-Id: I394897c10f02695f0416e87e9bf960e840bcb3b7
---
 cmds/bootanimation/BootAnimation.cpp | 13 ++++++++++---
 cmds/bootanimation/BootAnimation.h   |  3 ++-
 2 files changed, 12 insertions(+), 4 deletions(-)

diff --git a/cmds/bootanimation/BootAnimation.cpp b/cmds/bootanimation/BootAnimation.cpp
index c6b2f63..f374ece 100644
--- a/cmds/bootanimation/BootAnimation.cpp
+++ b/cmds/bootanimation/BootAnimation.cpp
@@ -68,6 +68,7 @@ namespace android {
 static const char OEM_BOOTANIMATION_FILE[] = "/oem/media/bootanimation.zip";
 static const char SYSTEM_BOOTANIMATION_FILE[] = "/system/media/bootanimation.zip";
 static const char SYSTEM_ENCRYPTED_BOOTANIMATION_FILE[] = "/system/media/bootanimation-encrypted.zip";
+static const char THEME_BOOTANIMATION_FILE[] = "/data/system/theme/bootanimation.zip";
 static const char SYSTEM_DATA_DIR_PATH[] = "/data/system";
 static const char SYSTEM_TIME_DIR_NAME[] = "time";
 static const char SYSTEM_TIME_DIR_PATH[] = "/data/system/time";
@@ -317,13 +318,14 @@ status_t BootAnimation::initTexture(SkBitmap *bitmap)
 
 
 // Get bootup Animation File
-// Parameter: ImageID: IMG_OEM IMG_SYS IMG_ENC
+// Parameter: ImageID: IMG_OEM IMG_SYS IMG_ENC IMG_THM
 // Return Value : File path
 const char *BootAnimation::getAnimationFileName(ImageID image)
 {
-    const char *fileName[3] = { OEM_BOOTANIMATION_FILE,
+    const char *fileName[4] = { OEM_BOOTANIMATION_FILE,
             SYSTEM_BOOTANIMATION_FILE,
-            SYSTEM_ENCRYPTED_BOOTANIMATION_FILE };
+            SYSTEM_ENCRYPTED_BOOTANIMATION_FILE,
+            THEME_BOOTANIMATION_FILE };
 
     // Load animations of Carrier through regionalization environment
     if (Environment::isSupported()) {
@@ -408,6 +410,9 @@ status_t BootAnimation::readyToRun() {
     if (encryptedAnimation && (access(getAnimationFileName(IMG_ENC), R_OK) == 0)) {
         mZipFileName = getAnimationFileName(IMG_ENC);
     }
+    else if (access(getAnimationFileName(IMG_THM), R_OK) == 0) {
+        mZipFileName = getAnimationFileName(IMG_THM);
+    }
     else if (access(getAnimationFileName(IMG_OEM), R_OK) == 0) {
         mZipFileName = getAnimationFileName(IMG_OEM);
     }
@@ -421,6 +426,8 @@ status_t BootAnimation::readyToRun() {
     FILE* fd;
     if (encryptedAnimation && access(getAnimationFileName(IMG_ENC), R_OK) == 0)
         fd = fopen(getAnimationFileName(IMG_ENC), "r");
+    else if (access(getAnimationFileName(IMG_THM), R_OK) == 0)
+        fd = fopen(getAnimationFileName(IMG_THM), "r");
     else if (access(getAnimationFileName(IMG_OEM), R_OK) == 0)
         fd = fopen(getAnimationFileName(IMG_OEM), "r");
     else if (access(getAnimationFileName(IMG_SYS), R_OK) == 0)
diff --git a/cmds/bootanimation/BootAnimation.h b/cmds/bootanimation/BootAnimation.h
index b70cc0e..958a022 100644
--- a/cmds/bootanimation/BootAnimation.h
+++ b/cmds/bootanimation/BootAnimation.h
@@ -122,8 +122,9 @@ private:
      *IMG_OEM: bootanimation file from oem/media
      *IMG_SYS: bootanimation file from system/media
      *IMG_ENC: encrypted bootanimation file from system/media
+     *IMG_THM: bootanimation file from data/system/theme
      */
-    enum ImageID { IMG_OEM = 0, IMG_SYS = 1, IMG_ENC = 2 };
+    enum ImageID { IMG_OEM = 0, IMG_SYS = 1, IMG_ENC = 2, IMG_THM = 3 };
     const char *getAnimationFileName(ImageID image);
     status_t initTexture(Texture* texture, AssetManager& asset, const char* name);
     status_t initTexture(const Animation::Frame& frame);
-- 
2.9.3

